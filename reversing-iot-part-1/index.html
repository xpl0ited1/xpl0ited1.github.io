<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="xpl0ited1" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="xpl0ited1" /> <title> Reversing IOT: Part 1 - xpl0ited1 </title> <link rel="alternate" href="https://xpl0ited1.io/reversing-iot-part-1/" hreflang="en-US" /> <link rel="canonical" href="https://xpl0ited1.io/reversing-iot-part-1/" /> <meta name="description" content="Bug Bounty Hunter, CyberSecurity Researcher @cntr0llz." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Reversing IOT: Part 1 | xpl0ited1" /> <meta property="og:title" content="Reversing IOT: Part 1 | xpl0ited1" /> <meta property="og:type" content="website" /> <meta property="og:url" content="https://xpl0ited1.io/reversing-iot-part-1/" /> <meta property="og:description" content="Bug Bounty Hunter, CyberSecurity Researcher @cntr0llz." /> <meta property="og:image" content="https://xpl0ited1.io/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Reversing IOT: Part 1 | xpl0ited11" /> <meta name="twitter:url" content="https://xpl0ited1.io/reversing-iot-part-1/" /> <meta name="twitter:site" content="@xpl0ited11" /> <meta name="twitter:creator" content="@xpl0ited11" /> <meta name="twitter:description" content="Bug Bounty Hunter, CyberSecurity Researcher @cntr0llz." /> <meta name="twitter:image" content="https://xpl0ited1.io/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="https://xpl0ited1.io/feed.xml" title="xpl0ited1" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="xpl0ited1" /> <meta name="application-name" content="xpl0ited1" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link" href="/about/">about</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <h1 class="header-title" itemprop="headline">Reversing IOT: Part 1</h1> <div class="post-meta"> <time datetime="2021-09-22T16:47:00-03:00" itemprop="datePublished"> Sep 22, 2021 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">xpl0ited1</span> </span> <time hidden datetime="" itemprop="dateModified"> Sep 22, 2021 </time> <span hidden itemprop="publisher" itemtype="Person">xpl0ited1</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><hr /> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <hr /> <p>Hello, it‚Äôs been a while since my last post, but I‚Äôm here now to show you some basic reverse engineering tips for some IOT devices, I mean with this post I‚Äôm starting a series of reverse engineering on IOT devices üë®‚Äçüíª.</p><hr /> <p>Well I cant disclose now the device tested and the vendor, so let‚Äôs say we are testing some Industrial LTE 4G router.</p> <p>First I‚Äôve downloaded the firmware from the vendor web page, and extracted the filesystem using binwalk:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xpl0ited1@freedom?<span class="nv">$ </span>binwalk <span class="nt">-e</span> firmware.bin
</code></pre></div></div> <p>Then I started to look for some common .cgi endpoints like web.cgi, this to check if there is some way to bypass the authentication schema. I noticed that every time the device checks if the user is logged in, it does it by using the <code class="language-plaintext highlighter-rouge">ICOS_CheckPrivilege</code> function:</p> <p><img src="img_27.png" alt="img_27.png" /></p> <p>Also I saw that the <code class="language-plaintext highlighter-rouge">ICOS_CheckPrivilege</code> function also is used to check the user privileges, I mean if the user is admin, guest, etc. That kind of check is made by passing the result of the <code class="language-plaintext highlighter-rouge">ICOS_CheckPrivilege</code> function to the address stored at <code class="language-plaintext highlighter-rouge">var_1c</code>, and then checking that address with the <code class="language-plaintext highlighter-rouge">level2str</code> function:</p> <p><img src="img.png" alt="img.png" /></p> <p>Inside the <code class="language-plaintext highlighter-rouge">level2str</code> function there is some kind of <code class="language-plaintext highlighter-rouge">switch/case</code> sentence that checks if the value stored at the address on <code class="language-plaintext highlighter-rouge">var_1c</code> is 1,2,3,4 or 5. By this way the function returns the user level:</p> <p><img src="img_1.png" alt="img_1.png" /></p> <p>With all that in mind my question was ‚Äúhow does the <code class="language-plaintext highlighter-rouge">ICOS_CheckPrivilege</code> function calculates sets the user level and why?‚Äù. Here is how the <code class="language-plaintext highlighter-rouge">ICOS_CheckPrivilege</code> function looks like:</p> <p><img src="img_4.png" alt="img_4.png" /></p> <p>When looking at the code of the function, I saw that the crypt function is used:</p> <p><img src="img_5.png" alt="img_5.png" /></p> <p>This function ‚Äúis the password encryption function. It is based on the Data Encryption Standard algorithm with variations intended (among other things) to discourage use of hardware implementations of a key search.‚Äù, and there is a paramater that is used for salting the key:</p> <p><img src="img_7.png" alt="img_7.png" /></p> <p>So for now I have that the <code class="language-plaintext highlighter-rouge">data_4bef464c</code> data reference is the salt for <code class="language-plaintext highlighter-rouge">arg2</code> or the <code class="language-plaintext highlighter-rouge">password input</code>:</p> <p><img src="img_28.png" alt="img_28.png" /></p> <p>When checking at the address of the data reference I‚Äôve got that the salt is just <code class="language-plaintext highlighter-rouge">$1$</code> ü§¶:</p> <p><img src="img_6.png" alt="img_6.png" /></p> <p>With all that in mind I made a few changes to the code of the function, modifying some variable names:</p> <p><img src="img_8.png" alt="img_8.png" /></p> <p>By other hand, there is a string comparison before comparing the password. At this comparison some value at R4 register is compared with the arg1, so I could guess that is the username, right?:</p> <p><img src="img_9.png" alt="img_9.png" /></p> <p>While examining the whole comparison code block, I noticed that is inside a do/while loop that increments by 1 the value of the R5 register every time until is 4, this remind the switch/case sentence, btw if the register is 4 it skips to the next line that check if the username is the same at the <code class="language-plaintext highlighter-rouge">data_4bef4650</code> data reference, which is iwu@fbt&amp;ND:</p> <p><img src="img_10.png" alt="img_10.png" /> <img src="img_12.png" alt="img_12.png" /></p> <p>This is how the <code class="language-plaintext highlighter-rouge">level2str</code> function looks like in Ghidra, as you can see if <code class="language-plaintext highlighter-rouge">param1</code> (var_1c) is 4 it does nothing, and if it is 5 the user level returned is <code class="language-plaintext highlighter-rouge">system</code>:</p> <p><img src="img_11.png" alt="img_11.png" /></p> <p>So basically if the username is <code class="language-plaintext highlighter-rouge">iwu@fbt&amp;ND</code> we are system:</p> <p><img src="img_13.png" alt="img_13.png" /></p> <p>But now what is the password for that user?, the password is stored at the <code class="language-plaintext highlighter-rouge">var_84</code> pointer:</p> <p><img src="img_14.png" alt="img_14.png" /></p> <p>I renamed the <code class="language-plaintext highlighter-rouge">var_84</code> variable to <code class="language-plaintext highlighter-rouge">system_pass_addr</code>, and if we look at the beggining of the function we could see the address were the password is stored in the stack:</p> <p><img src="img_15.png" alt="img_15.png" /></p> <p>So when looking at the stack we now have the address where the data reference of the system password is:</p> <p><img src="img_16.png" alt="img_16.png" /></p> <p><img src="img_17.png" alt="img_17.png" /></p> <p>After cracking the password with hashcat I got the system user password:</p> <p><img src="img_18.png" alt="img_18.png" /></p> <p>Now, looking in Shodan for some exposed devices I could saw that there a few:</p> <p><img src="img_19.png" alt="img_19.png" /></p> <p>When browsing in some of the exposed devices I got this initial web page that shows me as guest:</p> <p><img src="img_20.png" alt="img_20.png" /></p> <p>Then I‚Äôve logged in and had access to restricted functionalities:</p> <p><img src="img_22.png" alt="img_22.png" /></p> <p><img src="img_23.png" alt="img_23.png" /></p> <p><img src="img_24.png" alt="img_24.png" /></p> <p><img src="img_25.png" alt="img_25.png" /></p> <p>And of course there is and RCE üè¥‚Äç‚ò†Ô∏è that I‚Äôve already reported to mitre, and the best of all is fully unauthenticated, I‚Äôve just found it by exploring as authenticated user the device portal, but it is also leaked in some JS files:</p> <p><img src="img_26.png" alt="img_26.png" /></p><hr /> <p>And that‚Äôs all folks, thanks for reading, and I will post a second part of the full RCE when the vendor release a patch. Cheers!!! ü¶ú</p> <p>üè¥‚Äç‚ò†Ô∏è üè¥‚Äç‚ò†Ô∏è üè¥‚Äç‚ò†Ô∏è üè¥‚Äç‚ò†Ô∏è üè¥‚Äç‚ò†Ô∏è</p> </div> </article> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/gitgrep/" > <div class="nav-arrow">Previous</div> <span class="post-title">Tools: githubGrep</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="/thanks">ack.</a> <!-- <a class="footer_item" href="javascript::void(0)">resume</a>--> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2022</span> <small class="footer_copyright"> <!-- Klis√© Theme: https://github.com/piharpi/jekyll-klise --> <!-- <a--> <!-- href="https://github.com/piharpi/jekyll-klise"--> <!-- target="_blank"--> <!-- rel="noreferrer noopener"--> <!-- >klis√©</a--> <!-- >--> <!-- theme on--> <!-- <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener"--> <!-- >jekyll</a--> <!-- >--> </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
